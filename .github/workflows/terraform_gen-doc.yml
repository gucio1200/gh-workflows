---
name: Generate Docs
on:
  workflow_call:
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true
    inputs:
      terraform-docs-version:
        description: "Version of terraform-docs to use"
        type: string
        required: false
        # Default handled in logic
      working-dir:
        description: "Directory containing main.tf"
        type: string
        required: false
        default: "."

env:
  TERRAFORM_DOCS_VERSION: v0.20.0
  TF_DOCS_PATH: ${{ github.workspace }}/.bin/terraform-docs

jobs:
  main:
    name: Generate Docs
    runs-on: ubuntu-latest
    steps:
      - name: Calculate Version
        id: version
        run: |
          echo "VERSION=${{ inputs.terraform-docs-version || env.TERRAFORM_DOCS_VERSION }}" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Cache terraform-docs
        id: cache-tf-docs
        uses: actions/cache@v5
        with:
          path: ${{ env.TF_DOCS_PATH }}
          key: terraform-docs-${{ runner.os }}-${{ steps.version.outputs.VERSION }}

      - name: Install terraform-docs
        if: steps.cache-tf-docs.outputs.cache-hit != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p "$(dirname ${{ env.TF_DOCS_PATH }})"
          echo "Installing terraform-docs $VERSION..."

          curl -Lo tf-docs.tar.gz "https://github.com/terraform-docs/terraform-docs/releases/download/$VERSION/terraform-docs-$VERSION-$(uname)-amd64.tar.gz"
          tar -xzf tf-docs.tar.gz terraform-docs
          mv terraform-docs "${{ env.TF_DOCS_PATH }}"
          chmod +x "${{ env.TF_DOCS_PATH }}"
          rm tf-docs.tar.gz

      - name: Render terraform docs
        working-directory: ${{ inputs.working-dir || '.' }}
        run: |
          echo "Generating docs in $(pwd)"

          # Use the cached binary path
          "${{ env.TF_DOCS_PATH }}" markdown table \
            --output-file README.md \
            --output-mode inject \
            .

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: "docs: Update README.md"
          title: "docs: Update Terraform Documentation."
          body: |
            Automated update of `README.md` via `terraform-docs`.
            Triggered by commit: ${{ github.sha }}
          branch: docs/update-readme
          base: main
          delete-branch: true
          add-paths: ${{ inputs.working-dir || '.' }}/README.md
