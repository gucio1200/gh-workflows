---
name: Generate Docs

on:
  workflow_call:
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true
    inputs:
      terraform-docs-version:
        description: "Version of terraform-docs to use"
        type: string
        required: false
      gh-cli-version:
        description: "Version of gh cli to use"
        type: string
        required: false
      working-dir:
        description: "Directory containing main.tf"
        type: string
        required: false
        default: "."
      runs-on:
        description: "Default runner"
        required: false
        type: string
        default: "ubuntu-latest"

env:
  TERRAFORM_DOCS_VERSION: v0.20.0
  GH_CLI_VERSION: 2.86.0
  BIN_DIR: ${{ github.workspace }}/.bin

jobs:
  main:
    name: Generate Docs
    runs-on: ${{ inputs.runs-on || 'ubuntu-latest' }}
    steps:
      - name: Calculate Version
        id: version
        run: |
          echo "TF_DOC_VERSION=${{ inputs.terraform-docs-version || env.TERRAFORM_DOCS_VERSION }}" >> "$GITHUB_OUTPUT"
          echo "GH_CLI_VERSION=${{ inputs.gh-cli-version || env.GH_CLI_VERSION }}" >> "$GITHUB_OUTPUT"

      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ steps.generate-token.outputs.token }}

      - name: Cache terraform-docs
        id: cache-tf-docs
        uses: actions/cache@v5.0.3
        with:
          path: ${{ env.BIN_DIR }}/terraform-docs
          key: terraform-docs-${{ runner.os }}-${{ steps.version.outputs.TF_DOC_VERSION }}

      - name: Install terraform-docs
        if: steps.cache-tf-docs.outputs.cache-hit != 'true'
        run: |
          VERSION=${{ steps.version.outputs.TF_DOC_VERSION }}
          mkdir -p "${{ env.BIN_DIR }}"
          echo "Installing terraform-docs $VERSION..."
          curl -Lo tf-docs.tar.gz "https://github.com/terraform-docs/terraform-docs/releases/download/$VERSION/terraform-docs-$VERSION-$(uname)-amd64.tar.gz"
          tar -xzf tf-docs.tar.gz terraform-docs
          mv terraform-docs "${{ env.BIN_DIR }}/terraform-docs"
          chmod +x "${{ env.BIN_DIR }}/terraform-docs"
          rm tf-docs.tar.gz

      - name: Cache GH CLI
        id: cache-gh-cli
        uses: actions/cache@v5.0.3
        with:
          path: ${{ env.BIN_DIR }}/gh
          key: gh-cli-${{ runner.os }}-${{ steps.version.outputs.GH_CLI_VERSION }}

      - name: Install GH CLI
        if: steps.cache-gh-cli.outputs.cache-hit != 'true'
        run: |
          VERSION=${{ steps.version.outputs.GH_CLI_VERSION }}
          mkdir -p "${{ env.BIN_DIR }}"
          echo "Installing GH CLI v$VERSION..."
          curl -Lo gh-cli.tar.gz "https://github.com/cli/cli/releases/download/v${VERSION}/gh_${VERSION}_linux_amd64.tar.gz"
          tar -xzf gh-cli.tar.gz --strip-components=2 "gh_${VERSION}_linux_amd64/bin/gh"
          mv gh "${{ env.BIN_DIR }}/gh"
          chmod +x "${{ env.BIN_DIR }}/gh"
          rm gh-cli.tar.gz

      - name: Add Binaries to PATH
        run: echo "${{ env.BIN_DIR }}" >> $GITHUB_PATH

      - name: Render terraform docs
        working-directory: ${{ inputs.working-dir || '.' }}
        run: |
          echo "Generating docs in $(pwd)"
          terraform-docs markdown table \
            --output-file README.md \
            --output-mode inject \
            .

      - name: Push terraform docs
        working-directory: ${{ inputs.working-dir || '.' }}
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
          GH_HOST: ${{ github.server_url }}
        run: |
          export GH_HOST=${GH_HOST#*//}
          if [ -z "$(git status --porcelain README.md)" ]; then
             echo "No changes detected. Skipping push."
             exit 0
          fi

          FILE_PATH=$(realpath --relative-to="${{ github.workspace }}" README.md)
          BRANCH="${{ github.head_ref || github.ref_name }}"

          echo "Pushing $FILE_PATH to $BRANCH on $GH_HOST..."

          SHA=""
          if gh api --method HEAD "repos/$REPO/contents/$FILE_PATH?ref=$BRANCH" --hostname "$HOST_ONLY" >/dev/null 2>&1; then
             echo "File exists. Fetching SHA..."
             SHA=$(gh api "repos/$REPO/contents/$FILE_PATH?ref=$BRANCH" --hostname "$HOST_ONLY" --jq .sha)
          else
             echo "File does not exist. Creating new..."
          fi

          gh api --method PUT "/repos/${{ github.repository }}/contents/$FILE_PATH" \
            --hostname "$GH_HOST" \
            -f message="docs: update terraform-docs" \
            -f branch="$BRANCH" \
            -f content="$(base64 -w 0 README.md)" \
            ${SHA:+-f sha="$SHA"}
